<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #timer {
            font-size: 2rem;
            color: red;
        }
        .winner-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            border-radius: 5px;
        }
        .bid-button {
            margin-top: 10px;
        }
        .live-bidding-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .product-image {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div id="auctionContainer" class="container my-5">
        <div class="row">
            <!-- Product Details Section -->
            <div class="col-md-6">
                <h2 id="productName"></h2>
                <img id="productImage" class="product-image" alt="Product Image" />
                <p id="productDesc"></p>
                <p id="pickupLocation"></p>
                <p id="dropoffLocation"></p>
                <p id="productState"></p>
                <p id="shipper"></p> <!-- Shipper details -->
                <div id="timeLeft"></div>
            </div>

            <!-- Live Bidding Section -->
            <div class="col-md-6 live-bidding-section">
                <h4>Live Bidding</h4>
                <div id="timer" class="text-danger"></div>
                <div id="currentBid" class="mb-2">Current Lowest Bid: <strong>₹--</strong></div>
                <input type="number" id="bidInput" class="form-control mb-2" placeholder="Enter your bid" />
                <button id="placeBidBtn" class="btn btn-primary bid-button">Place Bid</button>
                <hr />
                <ul id="bidList" class="list-group"></ul>
                <div id="winnerSection" class="winner-section alert alert-success"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs ,setDoc,onSnapshot} from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    
        const socket = io("http://localhost:3000");
    
        let currentBid = Infinity;
        let currentWinner = null;
        let endTime;
    
        const postId = new URLSearchParams(window.location.search).get("postId");
        const uid = new URLSearchParams(window.location.search).get("uid");
        const username = decodeURIComponent(new URLSearchParams(window.location.search).get("username"));
        const email = decodeURIComponent(new URLSearchParams(window.location.search).get("email"));
    
        const firebaseConfig = {
            apiKey: "AIzaSyCt6CP-X7ds3fh8XK72fDx-4sMk1LFcOZk",
            authDomain: "shipping-wars.firebaseapp.com",
            projectId: "shipping-wars",
            storageBucket: "shipping-wars.firebasestorage.app",
            messagingSenderId: "513999333956",
            appId: "1:513999333956:web:8327a647aa8f3efa15ea11",
            measurementId: "G-JPYNN55M3X"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
    
        // Fetch Product and Shipper Details
        async function fetchProductDetails() {
            const docRef = doc(db, "shippingPosts", postId);
            const docSnap = await getDoc(docRef);
    
            if (docSnap.exists()) {
                const productData = docSnap.data();
                document.getElementById("productName").textContent = productData.itemName;
                document.getElementById("productDesc").textContent = productData.itemDesc;
                document.getElementById("pickupLocation").textContent = `Pickup: ${productData.pickup}`;
                document.getElementById("dropoffLocation").textContent = `Dropoff: ${productData.dropoff}`;
                document.getElementById("productState").textContent = `State: ${productData.state}`;
                document.getElementById("productImage").src = productData.imageURL;
    
                const shipperRef = doc(db, "users", productData.createdBy);
                const shipperSnap = await getDoc(shipperRef);
                if (shipperSnap.exists()) {
                    const shipperData = shipperSnap.data();
                    document.getElementById("shipper").textContent = `Seller: ${shipperData.username} (${shipperData.email})`;
                }
    
                endTime = new Date(productData.endTime).getTime();
                updateTimer();
            } else {
                console.error("No such product!");
            }
        }
    
        // Countdown Timer
        function updateTimer() {
            const now = new Date().getTime();
            const distance = endTime - now;
    
            if (distance <= 0) {
                clearInterval(timerInterval);
                document.getElementById("timer").textContent = "Auction Ended";

                // Wrap the await call inside an async IIFE
                (async () => {
                    const bidDocRef = doc(db, "bids", postId);
                    const bidSnap = await getDoc(bidDocRef);

                    let winnerText = "No bids placed";
                    if (bidSnap.exists()) {
                        const bidData = bidSnap.data();
                        if (bidData.currentWinner && bidData.currentBid !== undefined) {
                            winnerText = `The winner is ${bidData.currentWinner} with bid ₹${bidData.currentBid}`;
                        }
                    }

                    document.getElementById("winnerSection").style.display = 'block';
                    document.getElementById("winnerSection").textContent = winnerText;

                    // Disable the place bid button when auction ends
                    document.getElementById("placeBidBtn").disabled = true;
                })();

            } else {
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById("timer").textContent = `${hours}h ${minutes}m ${seconds}s`;
            }
        }
    
        // Place Bid Handler

        // Inside your existing click event
        document.getElementById("placeBidBtn").addEventListener("click", async function () {
            const bidAmount = parseInt(document.getElementById("bidInput").value);
            if (isNaN(bidAmount)) {
                alert("Please enter a valid bid amount.");
                return;
            }

            try {
                const bidDocRef = doc(db, "bids", postId);
                const bidDocSnap = await getDoc(bidDocRef);

                let currentFirestoreBid = Infinity;
                let previousBids = [];
                

                if (bidDocSnap.exists()) {
                    const bidData = bidDocSnap.data();
                    currentFirestoreBid = bidData.currentBid || Infinity;
                    previousBids = bidData.allBids || [];
                    currentWinner = bidData.currentWinner || null;
                }

                if (bidAmount >= currentFirestoreBid) {
                    alert(`Please place a bid LOWER than the current bid of ₹${currentFirestoreBid}`);
                    return;
                }

                // New valid bid
                const newBidEntry = {
                    bidAmount,
                    timestamp: new Date(),
                    user: {
                        uid,
                        username,
                        email
                    }
                };
                if (bidAmount < currentFirestoreBid) {
                    currentWinner = email; 
                }

                // Update Firestore
                await setDoc(bidDocRef, {
                    currentBid: bidAmount,
                    currentWinner: currentWinner,
                    allBids: [...previousBids, newBidEntry]
                }, { merge: true });

                // Emit to socket server
                socket.emit("placeBid", {
                    postId,
                    bid: bidAmount,
                    currentWinner,
                    bidders: [...previousBids, newBidEntry]  // you may want to trim this on frontend
                });

            } catch (error) {
                console.error("Bid placement failed:", error);
                alert("Something went wrong while placing the bid.");
            }
        });

        // Real-Time Bid Update Listener
        socket.on("updateBid", (data) => {
            currentBid = data.bid;
            document.getElementById("currentBid").innerHTML = `Current Lowest Bid: <strong>₹${currentBid}</strong>`;
    
            const biddersList = document.getElementById("bidList");
            biddersList.innerHTML = "";
    
            data.bidders.forEach((bidder) => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.textContent = `${bidder.email} bid ₹${bidder.bidAmount}`;
                biddersList.appendChild(li);
            });
        });
    
        socket.on("errorBid", (message) => {
            alert(message);
        });
    
        socket.emit("joinAuction", postId);
        const bidDocRef = doc(db, "bids", postId);

    onSnapshot(bidDocRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.currentBid !== undefined) {
                currentBid = data.currentBid;
                document.getElementById("currentBid").innerHTML = `Current Lowest Bid: <strong>₹${currentBid}</strong>`;
            }

            // Render bid list
            const biddersList = document.getElementById("bidList");
            biddersList.innerHTML = "";
            if (data.allBids) {
                data.allBids.slice().reverse().forEach((bidder) => {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = `${bidder.user.email.split('@')[0]} bid ₹${bidder.bidAmount}`;
                    biddersList.appendChild(li);
                });
            }
        } else {
            document.getElementById("currentBid").innerHTML = `Current Lowest Bid: <strong>₹--</strong>`;
            document.getElementById("bidList").innerHTML = "";
            currentBid = Infinity;
        }
    });

    fetchProductDetails();
    const timerInterval = setInterval(updateTimer, 1000);
    </script>    
    

</body>
</html>
